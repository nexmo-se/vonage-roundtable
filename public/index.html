
<html>
  <head>
    <title>Vonage Roundtable</title>

    <meta name="google-signin-client_id" content="751973864515-6ree7fbo4foclmtsq65ljpr5qgb761fk.apps.googleusercontent.com">
    <script src="https://apis.google.com/js/platform.js" async defer></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.5/socket.io.js" integrity="sha512-2rUSTSAeOO02jF6eBqENNqPs1EohenJ5j+1dgDPdXSLz9nOlrr8DJk4zW/lDy8rjhGCSonW3Gx812XJQIKZKJQ==" crossorigin="anonymous"></script>

    <script src="https://static.opentok.com/v2/js/opentok.min.js"></script>
    <!--script src="https://cdn.jsdelivr.net/npm/resonance-audio/build/resonance-audio.min.js"></script-->
    <script src="lib/audioLevel/audioLevel.js"></script>
    <script src="lib/layout/layout.js"></script>
    <script src="lib/annotation/annotation.js"></script>
    <script src="lib/participation/participation.js"></script>
    <script src="lib/stats/stats.js"></script>
    <!--script src="lib/spacial-audio/spacial-audio.js"></script-->

    <style>
      html, body {
        height: 100%;
        display: flex;
        flex-direction: row;
        width: 100vw;
        height: 100vh;
        overflow: hidden;
      }

      body, div {
        box-sizing: border-box;
        -moz-box-sizing: border-box;
        -webkit-box-sizing: border-box;
        margin: 0;
      }

      #layoutContainer::-webkit-scrollbar {
        display: none;
      }

      #layoutContainer {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      #speaker-control {
        width: 100%;
        height: 100%;
        overflow: hidden;
        display: none;
        flex-direction: column;
        flex: 1;
      }

      .fillAvailableHeight {
        height: 100%;
        height: -webkit-fill-available;
        height: fill-available;
      }
      .statslabel{
        padding-left: 5px;
        visibility: visible;
        line-height: 1.1;
        font-size: 11px;
        z-index: 100;
      }

      * {
        box-sizing: border-box;
      }

      .chat-area {
        display: flex;
        height: 100%;
        width: 100%;
        overflow: hidden;
        flex-direction: column;
      }

      .chat-area > .bubbles {
        overflow-y: auto;
        flex: 1;
        flex-basis: 85%;
      }

      .chat-area > .input-area {
        display: flex;
        flex: 1;
      }

      .chat-area > .input-area > div {
        flex: 1;
        margin-right: 16px;
      }

      .sidenav-container {
        width: 100%;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        flex: 1;
      }
        #combinedstats{
            position: fixed; 
            top: 0%; 
            left: 50%; 
            visibility: hidden;
            z-index: 999;
            background-color: purple;
            color: white;
        }
    </style>

    <link rel="stylesheet" href="volta.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  </head>
  <body>
    <div id="combinedstats">
        
    </div>
    <div id="videoContainer" class="fillAvailableHeight" style="position: relative; display: flex; flex: 1; flex-direction: row; background-color: black;">
      <div id="screenContainer" class="fillAvailableHeight" style="position: relative; display: flex; flex: 1; background-color: black; overflow: hidden;"></div>
      <div id="layoutContainer" class="fillAvailableHeight" style="position: relative; display: flex; width: 100%; background-color: black; flex-direction: row;"></div>

      <div id="subtitleContainer" style="width: 100%; position: absolute; z-index: 8999; bottom: 15px; left: 0; right: 0; padding-left: 5; padding-right: 5px; ">
        <div id="subtitleBubble" style="max-width: 100%; font-size: 18px; color: white; background-color: #00000080;"></div>
      </div>
      <div id="contenthint-control" style="width: 100%; position: absolute; z-index: 9999; bottom: 150px; left: 0; right: 0;" hidden>
          <div style="display: flex; flex-direction: row; justify-content: center; align-items: center;">
          <div class="Vlt-form__element" style="background-color: whitesmoke;padding: 20px">
              <label class="Vlt-label" for="content-hint-type">Content Hint</label>
              <div class="Vlt-select">
                <select id="content-hint-select">
                    <option value="" selected>None</option>
                    <option value="motion">Motion (Movies/Videos/Games)</option>
                    <option value="detail">Detail (Presentation/Web page with graphics)</option>
                    <option value="text">Text (Presentationn/Web page with lot of text)</option>
                </select><br/>
                <button class="Vlt-btn  Vlt-btn--primary Vlt-btn--icon"  onclick="onContentHintChanged()">
                    Start Screen share
                </button>
                <button class="Vlt-btn  Vlt-btn--primary Vlt-btn--icon"  onclick="onContentHintCancelled()">
                    Cancel
                </button>
              </div>
          </div>
          </div>      
      </div>
      <div id="stream-control" style="width: 100%; position: absolute; z-index: 9999; bottom: 50px; left: 0; right: 0;" hidden>
        <div style="display: flex; flex-direction: row; justify-content: center; align-items: center;">
          <div class="Vlt-tooltip Vlt-tooltip--top" title="Record Meeting">
            <button id="button-record" class="Vlt-btn Vlt-btn--large Vlt-btn--tertiary Vlt-btn--icon" style="margin-left: 5px; margin-right: 5px;" onclick="toggleRecord()">
              <svg><use xlink:href="volta-icons.svg#Vlt-icon-rec-full" /></svg>
            </button>
          </div>

          <div class="Vlt-tooltip Vlt-tooltip--top" style="margin-left: 5px; margin-right: 5px;" title="Enable/Disable Video">
            <button id="button-video-enable" class="Vlt-btn Vlt-btn--large Vlt-btn--primary Vlt-btn--icon" onclick="toggleVideoEnable()">
              <svg><use xlink:href="volta-icons.svg#Vlt-icon-video-negative" /></svg>
            </button>
          </div>

          <div class="Vlt-tooltip Vlt-tooltip--top" style="margin-left: 5px; margin-right: 5px;" title="Mute/Unmute">
            <button id="button-audio-enable" class="Vlt-btn Vlt-btn--large Vlt-btn--primary Vlt-btn--icon" onclick="toggleAudioEnable()">
              <svg><use xlink:href="volta-icons.svg#Vlt-icon-microphone-full" /></svg>
            </button>
          </div>

          <div class="Vlt-tooltip Vlt-tooltip--top" style="margin-left: 5px; margin-right: 5px;" title="Screenshare">
            <button id="button-screen-share" class="Vlt-btn Vlt-btn--large Vlt-btn--tertiary Vlt-btn--icon" onclick="toggleScreen()">
              <svg><use xlink:href="volta-icons.svg#Vlt-icon-screen-share-full" /></svg>
            </button>
          </div>

          <div class="Vlt-tooltip Vlt-tooltip--top" style="margin-left: 5px; margin-right: 5px;" title="Video Player">
            <button id="button-video-player" class="Vlt-modal-trigger Vlt-btn Vlt-btn--large Vlt-btn--tertiary Vlt-btn--icon" data-modal="videoPopupModal">
              <svg><use xlink:href="volta-icons.svg#Vlt-icon-small-video-full" /></svg>
            </button>
          </div>

          <div class="Vlt-tooltip Vlt-tooltip--top" style="margin-left: 5px; margin-right: 5px;" title="Cycle Camera">
            <button id="button-cycle-camera" class="Vlt-btn Vlt-btn--large Vlt-btn--tertiary Vlt-btn--icon" onclick="cycleCamera()">
              <svg><use xlink:href="volta-icons.svg#Vlt-icon-camera-switch-full" /></svg>
            </button>
          </div>

          <div class="Vlt-tooltip Vlt-tooltip--top" style="margin-left: 5px; margin-right: 5px;" title="Enable/Disable Transcription">
            <button id="button-transcription-enable" class="Vlt-btn Vlt-btn--large Vlt-btn--tertiary Vlt-btn--icon" onclick="toggleTranscription()">
              <svg><use xlink:href="volta-icons.svg#Vlt-icon-subtitles-full" /></svg>
            </button>
          </div>

          <div class="Vlt-tooltip Vlt-tooltip--top" style="margin-left: 5px; margin-right: 5px;" title="Enable/Disable Whiteboard">
            <button id="button-whiteboard-enable" class="Vlt-btn Vlt-btn--large Vlt-btn--tertiary Vlt-btn--icon" onclick="toggleWhiteboard()">
              <svg><use xlink:href="volta-icons.svg#Vlt-icon-compose-full" /></svg>
            </button>
          </div>
          
          <div class="Vlt-tooltip Vlt-tooltip--top" style="margin-left: 5px; margin-right: 5px;" title="End Meeting">
            <button id="button-end-call" class="Vlt-btn Vlt-btn--large Vlt-btn--destructive Vlt-btn--icon" onclick="endCall()">
              <svg><use xlink:href="volta-icons.svg#Vlt-icon-phone-down-full" /></svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="sidebar-control" style="display: none; padding-left: 16px; padding-right: 16px; background-color: black;">
      <button id="button-expand-sidebar" class="Vlt-btn Vlt-btn--app Vlt-btn--white Vlt-btn--icon" onclick="toggleSidebar()">
        <svg><use xlink:href="volta-icons.svg#Vlt-icon-collapse" /></svg>
      </button>
    </div>

    <div id="sidebar" style="display: flex; flex-direction: column; width: 450px; height: 100%; padding: 16px; background-color: #e6e6e6;">
      <button id="button-collapse-sidebar" class="Vlt-btn Vlt-btn--app Vlt-btn--white Vlt-btn--icon" style="display: block; margin-top: 4px; width: 40px; height: 40px;" onclick="toggleSidebar()">
        <svg><use xlink:href="volta-icons.svg#Vlt-icon-expand" /></svg>
      </button>

      <div class="Vlt-sidenav__block Vlt-sidenav__block--logo">
        <img class="Vlt-sidenav__elem--full" src="vonage-logo.svg"/>
      </div>

      <div class="sidenav-container">
        <div id="publisherContainerScreen" style="margin-bottom: 16px; display: none;"></div>

        <div id="room-control" class="Vlt-form__element" hidden>
          <label for="room" class="Vlt-label">Room Name</label>
          <div class="Vlt-input">
            <input type="text" id="room" />
          </div>
        </div>

        <div id="name-control" class="Vlt-form__element" hidden>
          <label for="name" class="Vlt-label">Display Name</label>
          <div class="Vlt-input">
            <input type="text" id="name" />
          </div>
        </div>

        <div id="session-control" style="margin-bottom: 16px;" hidden>
          <button id="connect" class="Vlt-btn Vlt-btn--primary" onclick="initializeSession()">Connect to Session</button>
        </div>
        <div id="google-connect" style="width: 100%;">
          <label for="name" class="Vlt-label">Sign In</label>
          <div class="g-signin2" data-onsuccess="onSignIn"></div>
        </div>

        <div id="speaker-control" hidden>
          <div class="Vlt-tabs" style="flex: 1; display: flex; flex-direction: column; width: 100%; height: 100%;" >
            <div class="Vlt-tabs__header Vlt-tabs__header--bordered">
              <div class="Vlt-tabs__link Vlt-tabs__link_active"><svg><use xlink:href="volta-icons.svg#Vlt-icon-chat-2"></use></svg><span>Chat</span></div>
              <div class="Vlt-tabs__link"><svg><use xlink:href="volta-icons.svg#Vlt-icon-group-2"></use></svg><span>Participants</span></div>
              <div class="Vlt-tabs__link"><svg><use xlink:href="volta-icons.svg#Vlt-icon-preferences"></use></svg><span>Settings</span></div>
            </div>
            <div class="Vlt-tabs__content" style="flex: 1; height: 0px">

              <!-- Chat Area -->
              <div class="Vlt-tabs__panel Vlt-tabs__panel_active" style="height: 100%;">
                <div class="chat-area">
                  <div id="chat-container" class="bubbles">
                  </div>
                  <div class="input-area">
                    <div class="Vlt-textarea" >
                      <textarea
                        rows="3"
                        id="chat-text"
                        placeholder="Type a message"
                        onkeyup="onChatEnter(event)"
                      ></textarea>
                    </div>
                    <button id="chat-button" class="Vlt-btn Vlt-btn--large Vlt-btn--secondary Vlt-btn--icon" style="margin-top: 0;" onclick="sendChat()">
                      <svg><use xlink:href="volta-icons.svg#Vlt-icon-message-read" /></svg>
                    </button>
                  </div>
                </div>                
              </div>
              <!-- End of Chat Area -->

              <div class="Vlt-tabs__panel" style="height: 100%;">
                <div><label id="participant-count" class="Vlt-label">Enable Sound Effect</label></div>
                <div id="speaker-list" style="padding: 16px; border: 1px solid #c2c4cc; border-radius: 5px; background-color: #fff;"></div>

                <div><label id="participant-stat-label" class="Vlt-label">Active Duration</label></div>
                <div id="speaker-stat-list" style="padding: 16px; border: 1px solid #c2c4cc; border-radius: 5px; background-color: #fff;"></div>
              </div>

              <div class="Vlt-tabs__panel" style="height: 100%;">
                <div style="width:100%; height: 100%; display: flex; flex-direction: column; overflow-y: scroll;">
                  <div style="width: 100%; height: 10px; display: flex; flex: 1; flex-direction: column;">
                    <div id="enable-sound" class="Vlt-form__element" style="display: flex; flex-direction: column;">
                      <div class="Vlt-checkbox">
                        <label for="enable-sound-checkbox">
                          <span class="Vlt-checkbox__button">
                            <input id="enable-sound-checkbox" type="checkbox" onchange="enableSound()" checked />
                            <span class="Vlt-checkbox__icon"></span>
                          </span>
                          Enable Sound Effect
                        </label>
                      </div>
                    </div>
                      
                    <div id="enable-stats" class="Vlt-form__element" style="display: flex; flex-direction: column;">
                      <div class="Vlt-checkbox">
                        <label for="enable-stats-checkbox">
                          <span class="Vlt-checkbox__button">
                            <input id="enable-stats-checkbox" type="checkbox" onchange="enableStats()" />
                            <span class="Vlt-checkbox__icon"></span>
                          </span>
                          Enable Stats
                        </label>
                      </div>
                    </div>
                    <!--div id="enhance-audio" class="Vlt-form__element" style="display: flex; flex-direction: column;">
                      <div class="Vlt-checkbox">
                        <label for="enhance-audio-checkbox">
                          <span class="Vlt-checkbox__button">
                            <input id="enhance-audio-checkbox" type="checkbox" onchange="enableSpatialAudio()"/>
                            <span class="Vlt-checkbox__icon"></span>
                          </span>
                          Enhance Audio
                        </label>
                      </div>
                    </div-->

                    <div class="Vlt-form__element">
                      <label class="Vlt-label" for="number-of-active-speakers-select">Number of on-screen speakers</label>
                      <div class="Vlt-select">
                        <select id="number-of-active-speakers-select" onchange="onActiveSpeakerSettingChanged(event)">
                          <option selected disabled>Select</option>
                          <option>2</option>
                          <option>3</option>
                          <option>4</option>
                          <option>5</option>
                          <option>6</option>
                          <option>7</option>
                          <option>8</option>
                          <option>9</option>
                          <option>10</option>
                          <option>11</option>
                          <option>12</option>
                          <option>13</option>
                          <option>14</option>
                          <option>15</option>
                          <option>16</option>
                          <option>17</option>
                          <option>18</option>
                          <option>19</option>
                          <option>20</option>
                          <option>21</option>
                          <option>22</option>
                          <option>23</option>
                          <option>24</option>
                          <option>25</option>
                        </select>
                      </div>
                    </div>

                    <div class="Vlt-form__element">
                      <label class="Vlt-label" for="number-of-active-speakers-select">Video Input</label>
                      <div class="Vlt-select">
                        <select id="video-source-select" onchange="onVideoSourceChanged(event)">
                        </select>
                      </div>
                    </div>

                    <div class="Vlt-form__element">
                      <label class="Vlt-label" for="number-of-active-speakers-select">Audio Input</label>
                      <div class="Vlt-select">
                        <select id="audio-source-select" onchange="onAudioSourceChanged(event)">
                        </select>
                      </div>
                    </div>

                    <div class="Vlt-form__element">
                      <label class="Vlt-label" for="number-of-active-speakers-select">Audio Output</label>
                      <div class="Vlt-select">
                        <select id="audio-sink-select" onchange="onAudioSinkChanged(event)">
                        </select>
                      </div>
                    </div>

                    <div id="mute-all" class="Vlt-form__element" style="display: none; flex-direction: column;" hidden>
                      <label class="Vlt-label">Mute All (admin only)</label>
                      <div class="Vlt-checkbox">
                        <label for="mute-all-checkbox">
                          <span class="Vlt-checkbox__button">
                            <input id="mute-all-checkbox" type="checkbox" onchange="muteAll()" />
                            <span class="Vlt-checkbox__icon"></span>
                          </span>
                          Mute All
                        </label>
                      </div>
                    </div>

                    <div id="recording" class="Vlt-form__element" style="display: none; flex: 1; flex-direction: column;" hidden>
                      <label class="Vlt-label">Recording (admin only)</label>
                      <button class="Vlt-btn Vlt-btn--secondary Vlt-btn--app" onclick="refreshArchives()">Refresh</button>

                      <div style="width: 100%; display: flex; flex: 1; flex-direction: column;">
                        <div id="archives-container" style="width: 100%; height: 100%; display: flex; flex-direction: column;">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
          
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="videoPopupModal" class="Vlt-modal">
      <div class="Vlt-modal__panel" style="width: 800px;">
        <div class="Vlt-modal__header">
          <h4>Notice</h4>
          <div class="Vlt-modal__dismiss"></div>
        </div>
        <div class="Vlt-modal__content">
          <div style="display: flex; flex-direction: column;">
            <div>This feature may not work on some newer Chrome versions.</div>
          </div>
        </div>
        <div class="Vlt-modal__footer" style="display: flex; flex-direction: row; justify-content: flex-start;">
          <button class="Vlt-btn Vlt-btn--app Vlt-btn--primary Vlt-modal__confirm" onclick="toggleVideoPlayer()">OK</button>
        </div>
      </div>
    </div>

    <script>
      const initialNumberOfActiveSpeakers = 2;
      const publisherResolution = { width: 640, height: 480 };
      const subscriberResolution = { width: 1280, height: 720 };
      const insertDefaultUI = true; // Whether to use default UI from Opentok or add manually

      const layoutContainer = document.getElementById("layoutContainer");
      const screenContainer = document.getElementById("screenContainer");

      let otStats = OTStats();
      otStats.setPublisherOnStatsAvailableListener(onPublisherStatsAvailable);
      otStats.setSubscriberOnStatsAvailableListener(onSubscriberStatsAvailable);
      otStats.setOnAggregateStatsAvailableListener(onAggregateStatsAvailable);
      let otParticipation = OTParticipation();
      otParticipation.setOnParticipationChangeListener(onParticipationChange);

      let otAnnotation = OTAnnotation();
      otAnnotation.setDrawListener(onStrokeDrawn);
      otAnnotation.setClearListener(onStrokeClear);

      let { adjustLayout, updateHighlight, addSelfSpeakerId, removeSelfSpeakerId } = OTLayout(layoutContainer, screenContainer);
      let otSpeech = OTSpeech({ numberOfActiveSpeakers: initialNumberOfActiveSpeakers });
      otSpeech.setOnActiveSpeakerChangeListener(onSpeakerOrderChanged);
      otSpeech.setOnMostActiveSpeakerChangeListener(onMostActiveSpeakerChanged);

      //let otSpacialAudio = OTSpacialAudio();

      let accessToken;

      let OTSession;
      let tokenParam = null;
      let cameraPublisher = null;
      let screenPublisher = null;
      let videoPublisher = null;

      let videoPlayerElement = null;
      let videoPlayerContainer = null;

      let recording = false;
      let enableSoundEffect = true;
      let enableStatsFlag = false;
      let enableAudio = true; // Assume not > 16 speakers
      let enableVideo = true; // Assume not > 16 speakers
      let unpublishDelay = 30; // 30s of disable audio + video to consider unpublishing
      let retryCount = 0;
      let retryLimit = 0;
      let roomName = null;
      let roomApiKey = null;
      let roomSessionId = null;
      let roomToken = null;
      let userRole = 'user';
      let connectionCount = 0;
      let videoCycleMode = 'auto';
      let enableTranscription = false;
      let enableWhiteboard = true;

      let audioDeviceIndex = 0;
      let videoDeviceIndex = 0;
      let audioSinkId = null;

      let streamControlHideTimeout = null;
      let hideControlDelay = 1000; // in milliseconds

      let transcriptionStarted = false;
      let transcriptionSocket;

      let whiteboardStarted = false;
      let whiteboardIFrame = null;
      let contentHintType = "";

      // Debouncing logic for handling window resize layout adjustment
      let notifySpeakerChangeTimeout = null;
      function notifySpeakerChange() {
        // Clear timeout if exist
        if (notifySpeakerChangeTimeout != null) {
          clearTimeout(notifySpeakerChangeTimeout);
        }

        // Set new timeout for actual adjustment
        notifySpeakerChangeTimeout = setTimeout(() => otSpeech.notifySpeakerChange(), 500);
      }
      // Listen for Window Resize
      window.addEventListener('resize', () => notifySpeakerChange());

      function playSoundEffect() {
        if (enableSoundEffect) {
          const audio = new Audio('sounds/vbc.mp3');
          audio.play();
        }
      }

      // Debouncing logic for sound effect
      let soundEffectTimeout = null;

      function playSoundEffectDebounce() {
        // Clear timeout if exist
        if (soundEffectTimeout != null) {
          clearTimeout(soundEffectTimeout);
        }

        // Set new timeout for actual sound effect
        soundEffectTimeout = setTimeout(() => playSoundEffect(), 500);
      }

      // Transcription Text
      let clearTranscriptionTimeout = null;
      function setTranscriptionText(text) {
        // Clear timeout if exist
        if (clearTranscriptionTimeout != null) {
          clearTimeout(clearTranscriptionTimeout);
        }

        document.getElementById('subtitleBubble').innerText = text;
        clearTranscriptionTimeout = setTimeout(() => {
          document.getElementById('subtitleBubble').innerText = '';
        }, 5000);
      }
      
      function waitForReady(callback) {
        /in/.test(document.readyState) ? setTimeout('waitForReady('+callback+')', 9) : callback();
      };

      function getParams() {
        const searchString = window.location.search || '?';
        const query = searchString.slice(1);
        const components = query.split(/&/g);
        const params = {};

        for (let i = 0; i < components.length; i += 1) {
          const component = components[i];
          const splitIndex = component.indexOf('=');
          if (splitIndex >= 0) {
            const rawKey = component.slice(0, splitIndex);
            const rawValue = component.slice(splitIndex + 1);
            const key = decodeURIComponent(rawKey);
            const value = decodeURIComponent(rawValue);
            params[key] = value;
          }
        }
        return params;
      };

      function handleError(error) {
        console.log(error);
      }

      async function getCredentials() {
        if (roomName != null && roomName !== '') {
          try {
            const url = `/token?room=${roomName}`;
            const config = {};
            if (accessToken != null && accessToken !== '') {
              config.headers = {
                Authorization: `Bearer ${accessToken}`,
              };
            }
            const response = await fetch(url, config);
            if (response.status === 401) {
              return Promise.reject(new Error('You are not authenticated, please refresh and login with the correct account'));
            } else if (response.status === 403) {
              return Promise.reject(new Error('Your email domain is not allowed, please refresh and login with the correct account'));
            }

            const data = await response.json();
            roomApiKey = data.apiKey;
            roomSessionId = data.sessionId;
            roomToken = data.token;
            
            // Update Mute
            document.getElementById('mute-all-checkbox').checked = data.muteOnJoin;

            // Update Whiteboard
            if (data.whiteboardOnJoin) {
              startWhiteboard(false);
            }

            enableAudio = !data.muteOnJoin;
            return Promise.resolve(data);
          } catch (error) {
            console.log(error.message);
            error.code = 1006;
            return Promise.reject(error);
          }
        } else if (tokenParam != null && tokenParam !== '') {
          // Decode Token
          const b64Encoded = tokenParam.slice(4);
          const buffer = atob(b64Encoded);
          const b64Decoded = buffer.toString('ascii');

          // Read Decoded Data for Api Key and Session Id
          const components = b64Decoded.split(/&|:/g);
          const data = {};
          for (let i = 0; i < components.length; i += 1) {
            const component = components[i];
            const firstEqualIndex = component.indexOf('=');
            if (firstEqualIndex <= 0) {
              continue;
            }

            const key = component.slice(0, firstEqualIndex);
            const value = component.slice(firstEqualIndex + 1);
            data[key] = value;
          }

          roomApiKey = data.partner_id,
          roomSessionId = data.session_id;
          roomToken = tokenParam;
          return Promise.resolve({
            apiKey: data.partner_id,
            sessionId: data.session_id,
            token: tokenParam,
          });
        }

        // Default
        try {
          const url = `/token`;
          const config = {};
          if (accessToken != null && accessToken !== '') {
            config.headers = {
              Authorization: `Bearer ${accessToken}`,
            };
          }
          const response = await fetch(url, config);
          const data = await response.json();
          roomApiKey = data.apiKey;
          roomSessionId = data.sessionId;
          roomToken = data.token;
          return Promise.resolve(data);
        } catch (error) {
          console.log(error.message);
          error.code = 1006;
          return Promise.reject(error);
        }
      }

      function createArchiveElement(archive) {
        const { id, createdAt, duration, status, url } = archive;

        const createdAtDate = new Date(createdAt);
        const date = createdAtDate.getDate();
        const month = createdAtDate.getMonth() + 1;
        const year = createdAtDate.getFullYear();
        const hour = createdAtDate.getHours();
        const minute = createdAtDate.getMinutes();
        const dateText = `${date}-${month}-${year} ${hour}:${minute}`;

        let durationText = '';
        if (duration >= 60) {
          const durationMinute = Math.floor(duration / 60);
          const durationSeconds = Math.floor(duration % 60);
          durationText = `${durationMinute}m ${durationSeconds}s`;
        } else if (duration > 0) {
          durationText = `${duration}s`;
        }

        const archiveElement = document.createElement('div');
        archiveElement.style.width = '100%';
        archiveElement.style.display = 'flex';
        archiveElement.style.flexDirection = 'row';
        archiveElement.style.padding = '16px';
        archiveElement.style.alignItems = 'center';

        const infoContainer = document.createElement('div');
        infoContainer.style.display = 'flex';
        infoContainer.style.flex = '1';
        infoContainer.style.flexDirection = 'column';

        const dateElement = document.createElement('div');
        dateElement.innerText = dateText;
        dateElement.style.fontWeight = '700';

        const durationElement = document.createElement('div');
        durationElement.innerText = `${status} ${durationText === '' ? '' : `- ${durationText}`}`;
        durationElement.style.fontStyle = 'italic';

        infoContainer.appendChild(dateElement);
        infoContainer.appendChild(durationElement);

        archiveElement.appendChild(infoContainer);

        if (status === 'available') {
          const downloadButton = document.createElement('button');
          downloadButton.classList.add('Vlt-btn', 'Vlt-btn--tertiary', 'Vlt-btn--icon');
          downloadButton.innerHTML='<svg><use xlink:href="volta-icons.svg#Vlt-icon-download-full" /></svg>';
          //downloadButton.onclick = () => window.open(url, '__blank');
          downloadButton.onclick = () => {
            const aElement = document.createElement('a');
            aElement.href = `/archives/${id}/download`;
            aElement.download = 'archive.mp4';
            aElement.click();
          };
          
          archiveElement.appendChild(downloadButton);
        }

        return archiveElement;
      }

      async function refreshArchives() {
        try {
          const url = `/archives?sessionId=${roomSessionId}`;
          const config = {};
          if (accessToken != null && accessToken !== '') {
            config.headers = {
              Authorization: `Bearer ${accessToken}`,
            };
          }
          const response = await fetch(url, config);
          const archives = await response.json();

          refreshRecording(archives);

          const archiveContainer = document.getElementById('archives-container');
          archiveContainer.innerHTML = '';
          const elements = archives.map(createArchiveElement);
          for (let i = 0; i < elements.length; i += 1) {
            const element = elements[i];
            archiveContainer.appendChild(element);
          }
        } catch (error) {
          console.error(error);
        }
      }

      function urlify(text) {
        var urlRegex = /(https?:\/\/[^\s]+)/g;
        return text.replace(urlRegex, function(url) {
          return '<a href="' + url + '" target="_blank" style="color: white;">' + url + '</a>';
        });
        // or alternatively
        // return text.replace(urlRegex, '<a href="$1">$1</a>')
      }

      async function initializeSession() {
        try {
          // Disable button
          document.getElementById("connect").disabled = true;
          document.getElementById("google-connect").disabled = true;

          // Check Room Name sanity
          roomName = document.getElementById('room').value;
          if (roomName == null || roomName === '') {
            document.getElementById("connect").disabled = false;
            alert('Please provide a room name');
            return;
          }
          document.getElementById('room').disabled = true;
          document.getElementById('room-control').hidden = true;

          // Check Display Name sanity
          const name = document.getElementById('name').value;
          if (name == null || name === '') {
            document.getElementById("connect").disabled = false;
            alert('Please provide a name');
            return;
          }
          document.getElementById('name').disabled = true;
          document.getElementById('name-control').hidden = true;

          // Get Credentials
          const credentials = await getCredentials();
          const { apiKey, sessionId, token } = credentials;

          OTSession = OT.initSession(apiKey, sessionId);
          console.log('Session Created');

          OTSession.on("connectionCreated", function(event) {
            console.log('Session connectionCreated');
            connectionCount++;
            updateConnectionCount();

            // Play Join Sound
            playSoundEffectDebounce();
          });
          OTSession.on("connectionDestroyed", function(event) {
            console.log('Session connectionDestroyed');
            connectionCount--;
            updateConnectionCount();

            // Play Leave Sound
            playSoundEffectDebounce();
          });

          OTSession.on('streamCreated', (event) => {
            console.log('Session streamCreated');
            const layoutContainer = event.stream.videoType === 'screen' || event.stream.videoType === 'custom' ? 'screenContainer' : 'layoutContainer';
            var subscriber = OTSession.subscribe(event.stream, insertDefaultUI ? layoutContainer : null, {
              insertMode: insertDefaultUI ? 'append' : undefined, // not using insert mode for insertDefaultUI true
              fitMode: insertDefaultUI ? 'contain' : undefined, // not using fit mode for insertDefaultUI true
              insertDefaultUI,
              nameDisplayMode : 'on',
	      preferredFrameRate: 30,
              width: event.stream.videoType === 'screen' ? '100%' : 1280,
              height: event.stream.videoType === 'screen' ? '100%' : 720,
              preferredResolution: subscriberResolution,
            }, (error) => {
              if (error) {
                return handleError(error);
              }

              // Add Subscriber to OT Speech
              if (event.stream.videoType !== 'screen') {
                otSpeech.addSubscriber(subscriber);
              }
            
              console.log("subscriber ID - "+subscriber.id)
              var label = document.createElement("label");
              label.id = subscriber.id+"lbl";
              label.classList.add("statslabel");
              document.getElementById(subscriber.id).appendChild(label);
              otStats.addSubscriber(subscriber);
               
              /*if(spacialAudioSupported){
                  otSpacialAudio.connectVideoToResonanceAudio(subscriber.id)
              }*/
            });

            // Add Subscriber Annotation (screen only)
            if (event.stream.videoType === 'screen') {
              otAnnotation.startSubscriber(subscriber);
            }

            // Note: Use this only if InsertDefaultUI is false
            if (!insertDefaultUI) {
              subscriber.on('videoElementCreated', (e) => {
                console.log('Subscriber videoElementCreated');
                const videoElement = e.element;
                videoElement.style.width = event.stream.videoType === 'screen' ? '100%' : '100%';
                videoElement.style.height = event.stream.videoType === 'screen' ? 'auto' : '100%';
                videoElement.style.objectFit = 'contain';

                const divElement = document.createElement('div');
                divElement.id = e.target.stream.id;
                divElement.style.margin = 'auto';
                divElement.appendChild(videoElement);

                const layoutContainer = event.stream.videoType === 'screen' || event.stream.videoType === 'custom' ? 'screenContainer' : 'layoutContainer';
                document.getElementById(layoutContainer).appendChild(divElement);

                otSpeech.notifySpeakerChange();
              });
            } else {
              otSpeech.notifySpeakerChange();
            }
          });

          OTSession.on('sessionReconnecting', (event) => {
            console.log('Session sessionReconnecting');
          });

          OTSession.on('sessionReconnected', (event) => {
            console.log('Session sessionReconnected');

            if (cameraPublisher) {
              stopCamera();
              startCamera();
            }
          });

          OTSession.on('streamDestroyed', (event) => {
            console.log('Session streamDestroyed');

            // Remove Subscriber Annotation (screen only)
            if (event.stream.videoType === 'screen') {
              const subscriber = otSpeech.getSubscriberIdByStreamId(event.stream.id);
              otAnnotation.endSubscriber(subscriber);
            }

            // Remove Subscriber from OT Speech
            otSpeech.removeSubscriberByStreamId(event.stream.id);

            // Remove Subscriber Stream from Participation
            otParticipation.deleteParticipant(event.stream.id);
            otStats.removeSubscriber(event.stream.id);

            // Remove Subscriber div
            const layoutContainer = event.stream.videoType === 'screen' ? 'screenContainer' : 'layoutContainer';
            const containerElement = document.getElementById(layoutContainer);
            const childNodes = containerElement.childNodes;
            for (let i = 0; i < childNodes.length; i += 1) {
              const childNode = childNodes[i];
              if (childNode.id === event.stream.id) {
                // Remove Child Element
                containerElement.removeChild(childNode);
              }
            }

            otSpeech.notifySpeakerChange();
          });

          OTSession.on('sessionDisconnected', (event) => {
            console.log('Session sessionDisconnected');

            const { reason } = event;
            if (reason === 'networkDisconnected') {
              console.log('Network disconnected, attempting reconnection');
              OTSession.disconnect();
              connect(true);
            }
          });

          OTSession.on('signal', (e) => {
            const { type, data } = e;

            if (type === 'signal:transcription') {
              setTranscriptionText(data);
            } else if (type === 'signal:transcriptionStatus') {
              transcriptionStarted = data === 'started';
              if (transcriptionStarted) {
                document.getElementById('button-transcription-enable').classList.remove('Vlt-btn--tertiary');
                document.getElementById('button-transcription-enable').classList.add('Vlt-btn--primary');
              } else {
                document.getElementById('button-transcription-enable').classList.add('Vlt-btn--tertiary');
                document.getElementById('button-transcription-enable').classList.remove('Vlt-btn--primary');
              }
            } else if (type === 'signal:muteall') {
              console.log('received mute all signal');
              enableAudio = false;
              cameraPublisher.publishAudio(enableAudio);
              
              document.getElementById('button-audio-enable').classList.remove('Vlt-btn--primary');
              document.getElementById('button-audio-enable').classList.add('Vlt-btn--tertiary');
              document.getElementById('button-audio-enable').innerHTML = `<svg><use xlink:href="volta-icons.svg#Vlt-icon-microphone-mute-full" /></svg>`;
            } else if (type === 'signal:whiteboard') {
              const { enabled } = JSON.parse(data);
              if (enabled) {
                startWhiteboard(false);
              } else {
                stopWhiteboard(false);
              }
            } else if (type === 'signal:chat') {
              const { name, text } = JSON.parse(data);

              const row = document.createElement('div');
              row.style.width = '100%';
              row.style.display = 'flex';
              row.style.flexDirection = 'row';
              row.style.padding= '5px';

              const bubble = document.createElement('div');
              bubble.style.flexDirection = 'column';
              bubble.style.justifyContent = 'center';
              bubble.style.minWidth = '32px';
              bubble.style.maxWidth = '80%';
              bubble.style.paddingLeft = '8px';
              bubble.style.paddingRight = '8px';
              bubble.style.paddingTop = '4px';
              bubble.style.paddingBottom = '4px';
              bubble.style.marginBottom = '8px';
              bubble.style.borderRadius = '16px';
              bubble.style.color = '#ffffff';
              bubble.style.whiteSpace = 'pre-wrap';
              bubble.style.wordWrap = 'break-word';
              bubble.style.overflowWrap = 'break-word';
              bubble.style.wordBreak = 'break-word';
              bubble.innerHTML = urlify(text);

              const isSelf = name === document.getElementById('name').value;
              if (isSelf) {
                row.style.flexDirection = 'row-reverse';

                bubble.style.backgroundColor = '#871fff';
              } else {
                bubble.style.backgroundColor = '#767676';
                bubble.innerHTML = '';
                
                const nameDiv = document.createElement('div');
                nameDiv.innerText = name;
                nameDiv.style.fontWeight = 'bold';

                const textDiv = document.createElement('div');
                textDiv.style.whiteSpace = 'pre-wrap';
                textDiv.style.wordWrap = 'break-word';
                textDiv.style.overflowWrap = 'break-word';
                textDiv.style.wordBreak = 'break-word';
                textDiv.innerHTML = urlify(text);

                bubble.appendChild(nameDiv);
                bubble.appendChild(textDiv);
              }

              row.appendChild(bubble);
              document.getElementById('chat-container').appendChild(row);

              console.log(`${name}${isSelf ? ' (me)' : ''} - ${text}`);
            } else if (type === 'signal:draw-stroke') {
              const { streamName, stroke } = JSON.parse(data);
              otAnnotation.addStroke(streamName, stroke);
            } else if (type === 'signal:draw-clear') {
              console.log('clear received');
              const { streamName } = JSON.parse(data);
              otAnnotation.clearDrawing(streamName);
            } else {
              console.log(`Signal: type ${type}, data ${data}`);
            }
          });

          connect(false);

          return Promise.resolve();
        } catch (error) {
          alert(error.message);
          return Promise.resolve();
        }
      }

      async function connect(retry) {
        try {
          const credentials = await getCredentials();
          OTSession.connect(credentials.token, (error) => {
            if (error) {
              if (retry && error.code == 1006 && (retryLimit === 0 || (retryLimit > 0 && retryCount > 0))) {
                console.log('Will attempt reconnect');
                retryCount -= 1; // Decrease Count
                setTimeout(() => connect(retry), 5000);
                return;
              };
              handleError(error);
              alert(error.message);
              return;
            }

            retryCount = retryLimit; // Reset Count
            
            console.log('Session Ready');
            document.getElementById('google-connect').hidden = true;
            document.getElementById('session-control').hidden = true;
            document.getElementById('speaker-control').hidden = false;
            document.getElementById('speaker-control').style.display = 'flex';
            
            if (enableAudio) {
              document.getElementById('button-audio-enable').classList.remove('Vlt-btn--tertiary');
              document.getElementById('button-audio-enable').classList.add('Vlt-btn--primary');
              document.getElementById('button-audio-enable').innerHTML = `<svg><use xlink:href="volta-icons.svg#Vlt-icon-microphone-full" /></svg>`;
            } else {
              document.getElementById('button-audio-enable').classList.remove('Vlt-btn--primary');
              document.getElementById('button-audio-enable').classList.add('Vlt-btn--tertiary');
              document.getElementById('button-audio-enable').innerHTML = `<svg><use xlink:href="volta-icons.svg#Vlt-icon-microphone-mute-full" /></svg>`;
            }
            
            if (enableVideo) {
              document.getElementById('button-video-enable').classList.remove('Vlt-btn--tertiary');
              document.getElementById('button-video-enable').classList.add('Vlt-btn--primary');
              document.getElementById('button-video-enable').innerHTML = `<svg><use xlink:href="volta-icons.svg#Vlt-icon-video-negative" /></svg>`;
            } else {
              document.getElementById('button-video-enable').classList.remove('Vlt-btn--primary');
              document.getElementById('button-video-enable').classList.add('Vlt-btn--tertiary');
              document.getElementById('button-video-enable').innerHTML = `<svg><use xlink:href="volta-icons.svg#Vlt-icon-video-off-full" /></svg>`;
            }

            isTranscriptionRunning()
              .then(result => transcriptionStarted = result)
              .then(() => {
                if (transcriptionStarted) {
                  document.getElementById('button-transcription-enable').classList.remove('Vlt-btn--tertiary');
                  document.getElementById('button-transcription-enable').classList.add('Vlt-btn--primary');
                } else {
                  document.getElementById('button-transcription-enable').classList.add('Vlt-btn--tertiary');
                  document.getElementById('button-transcription-enable').classList.remove('Vlt-btn--primary');
                }
              })
              .catch(error => console.error(error));

            // Set Stream Control Listener
            setStreamControlHoverListener();

            // Refresh Archives
            refreshArchives();

            // Automatically start publishing camera
            startCamera();

            // Join Transcription Room
            joinTranscriptionRoom();
          });
        } catch (error) {
          if (retry && error.code == 1006 && (retryLimit === 0 || (retryLimit > 0 && retryCount > 0))) {
            console.error(error.message);
            console.log('Will attempt reconnect');
            retryCount -= 1; // Decrease Count
            setTimeout(() => connect(retry), 5000);
            return;
          }
          console.error(error);
        }
      }

      // This callback/listener will handle the change of speaker order
      // based on the speech detection via audio level
      function onSpeakerOrderChanged(updatedSpeakers, positions, numberOfActiveSpeakers) {
        // Use Subscriber ID for InsertDefaultUI true
        // Use Stream ID for InsertDefaultUI false
        const mappedPositions = positions.map(position => insertDefaultUI ? otSpeech.getSubscriberIdByStreamId(position) : position)
          .filter(subscriberId => subscriberId != null);

        adjustLayout(mappedPositions, numberOfActiveSpeakers);
        otAnnotation.updateCanvases();
        updateSpeakerPins();

        if (audioSinkId != null && audioSinkId !== '') {
          console.log('Updating audio sink for all video elements');
          const elements = document.getElementsByTagName('video');
          for (let i = 0; i < elements.length; i += 1) {
            const element = elements[i];
            element.setSinkId(audioSinkId);
          }
        }
      }

      // This callback/listener will handle the most active speaker changed event
      // which is used to update the speaker highlight
      function onMostActiveSpeakerChanged(mostActiveSpeakerId) {
        // Use Subscriber ID for InsertDefaultUI true
        // Use Stream ID for InsertDefaultUI false
        const mappedId = insertDefaultUI ? otSpeech.getSubscriberIdByStreamId(mostActiveSpeakerId) : mostActiveSpeakerId
          .filter(subscriberId => subscriberId != null);
        updateHighlight(mappedId);

        // Set participant
        otParticipation.setCurrentParticipant(mostActiveSpeakerId);
      }

      function onParticipationChange() {
        // Update Participation List
        const latestParticipations = otParticipation.getParticipations();
        const participants = Object.keys(latestParticipations)
          .map((participantId) => {
            const participantStream = otSpeech.getStreamByStreamId(participantId);
            const participantName = (participantStream || {}).name || ' Unknown';
            const participationDuration = latestParticipations[participantId] || 0;
            let participationDurationText = '';

            // h m s ms
            let leftover = participationDuration;
            const hour = Math.floor(leftover / 3600000);
            leftover = leftover % 3600000;
            const minute = Math.floor(leftover / 60000);
            leftover = leftover % 60000;
            const second = Math.floor(leftover / 1000);
            leftover = leftover % 1000;
            const millisecond = leftover;

            if (hour > 0) {
              participationDurationText += `${hour} h `;
            }
            if (minute > 0 || participationDurationText !== '') {
              participationDurationText += `${minute} m `;
            }
            if (second > 0 || participationDurationText !== '') {
              participationDurationText += `${second} s `;
            }
            participationDurationText += `${millisecond} ms`;

            return {
              id: participantId,
              name: participantName,
              duration: participationDuration,
              durationText: participationDurationText,
            };
          })
          .sort((a, b) => b.duration - a.duration);

        // Clear previous list
        const participationListElement = document.getElementById('speaker-stat-list');
        participationListElement.innerText = '';

        // Add new list
        for (let i = 0; i < participants.length; i += 1) {
          const participant = participants[i];
          const { name, durationText } = participant;

          // Create element
          const participantElement = document.createElement('div');
          participantElement.style.width = '100%';
          participantElement.style.display = 'flex';
          participantElement.style.flexDirection = 'row';
          participantElement.style.alignItems = 'center';
          participantElement.innerText = `${name} - ${durationText}`;

          // Add to list
          participationListElement.appendChild(participantElement);
        }
      }

      // This callback/listener will handle annotation drawing event
      function onStrokeDrawn(streamName, stroke) {
        // Send Signal for stroke
        OTSession.signal({
          type: 'draw-stroke',
          data: JSON.stringify({
            streamName,
            stroke,
          }),
        }, (error) => error && console.error(error));
      }

      // This callback/listener will handle annotation drawing event
      function onStrokeClear(streamName) {
        // Send Signal for stroke
        OTSession.signal({
          type: 'draw-clear',
          data: JSON.stringify({
            streamName,
          }),
        }, (error) => error && console.error(error));
      }

      function toggleCamera() {
        if (cameraPublisher == null) {
          startCamera();
        } else {
          stopCamera();
        }
      }

      function toggleScreen() {
        if (screenPublisher == null) {
          showContentHintDialog();
        } else {
          stopScreen();
        }
      }

      function toggleVideoPlayer() {
        if (videoPublisher == null) {
          const fileInput = document.createElement('input');
          fileInput.type = 'file';
          fileInput.onchange = () => {
            if (fileInput.files.length <= 0) {
              return;
            }

            const file = fileInput.files[0];
            startVideoPlayer(file);
          }
          fileInput.click();
        } else {
          stopVideoPlayer();
        }
      }

      function setVideoSource(videoSource) {
        if (cameraPublisher == null) {
          return;
        }

        cameraPublisher.setVideoSource(videoSource)
      }

      function setAudioSource(audioSource) {
        if (cameraPublisher == null) {
          return;
        }

        cameraPublisher.setAudioSource(audioSource)
      }
      
      async function startCamera() {
        stopCamera();
        try {
          const name = document.getElementById('name').value;
          if (name == null || name === '') {
            alert('Please provide a name');
            return;
          }

          const options = {
            publishAudio: enableAudio,
            publishVideo: enableVideo,
            fitMode: 'contain',
            insertMode: 'append',
            showControls: false,
            name,
            width: '100%',
            resolution: `${publisherResolution.width}x${publisherResolution.height}`,
            frameRate: 30
          };

          if (videoCycleMode !== 'auto') {
            if (videoDeviceIndex > -1) {
              const videoDevice = await getVideoInput(videoDeviceIndex);
              if (videoDevice != null) {
                options.videoSource = videoDevice.deviceId;
              }
            }

            if (audioDeviceIndex > -1) {
              const audioDevice = await getAudioInput(audioDeviceIndex);
              if (audioDevice != null) {
                options.audioSource = audioDevice.deviceId;
              }
            }
          }

          cameraPublisher = OT.initPublisher('layoutContainer', options, (error) => {
            if (error) {
              handleError(error);
              return;
            }

            // Publish to Session
            console.log("Publisher ID - "+cameraPublisher.id)
            var label = document.createElement("label");
            label.id = cameraPublisher.id+"lbl";
            label.classList.add("statslabel");
            document.getElementById(cameraPublisher.id).appendChild(label);
            OTSession.publish(cameraPublisher, (err) => {
              if (err) {
                handleError(error);
                return;
              }
              otStats.addPublisher(cameraPublisher);
              //otStats.start();
            });
          });

          cameraPublisher.on('streamCreated', (event) => {
            console.log('Camera Publisher streamCreated');
              // Add to screen
              const speakerId = insertDefaultUI ? cameraPublisher.id : event.stream.id;
              addSelfSpeakerId(speakerId);
              otSpeech.addSelf();
              otSpeech.notifySpeakerChange();
          });

          cameraPublisher.on('streamDestroyed', (event) => {
            console.log('Camera Publisher streamDestroyed');
              // Add to screen
              const speakerId = insertDefaultUI ? cameraPublisher.id : event.stream.id;
              removeSelfSpeakerId(speakerId);
              otSpeech.removeSelf();
              otSpeech.notifySpeakerChange();
          });
        } catch (error) {
          handleError(error);
        }
      }
      
      function onPublisherStatsAvailable(id,video,audio){
          document.getElementById(id+"lbl").innerHTML = video.width+"x"+video.height+"@"+video.frameRate+"fps<br/>VBW:"+video.bandwidth+"Kbps PL:"+video.packetLoss+"%<br/>ABW:"+audio.bandwidth+"Kbps PL:"+audio.packetLoss+"%";
      }
      function onSubscriberStatsAvailable(id, video, audio){
          document.getElementById(id+"lbl").innerHTML = video.width+"x"+video.height+"@"+video.frameRate+"fps<br/>VBW:"+video.bandwidth+"Kbps PL:"+video.packetLoss+"%<br/>ABW:"+audio.bandwidth+"Kbps PL:"+audio.packetLoss+"%";
      }
        
      function onAggregateStatsAvailable(stats){
          document.getElementById("combinedstats").innerHTML = "VBW:"+stats.vbw+"Kbps ABW:"+stats.abw+"Kbps"; 
      }
      function stopCamera() {
        if (cameraPublisher != null) {
          OTSession.unpublish(cameraPublisher);
          cameraPublisher = null;
        }
      }

      function listInputs() {
        return new Promise((resolve, reject) => {
          OT.getDevices((error, devices) => {
            if (error) {
              reject(error);
            } else {
              resolve(devices);
            }
          });
        });
      }

      function listOutputs() {
        return navigator.mediaDevices.enumerateDevices();
      }

      async function listVideoInputs() {
        try {
          const devices = await listInputs();
          const filteredDevices = devices.filter(device => device.kind === 'videoInput');
          return Promise.resolve(filteredDevices);
        } catch (error) {
          return Promise.reject(error);
        }
      }

      async function listAudioInputs() {
        try {
          const devices = await listInputs();
          const filteredDevices = devices.filter(device => device.kind === 'audioInput');
          return Promise.resolve(filteredDevices);
        } catch (error) {
          return Promise.reject(error);
        }
      }

      async function listAudioOutputs() {
        try {
          const devices = await listOutputs();
          // console.log(devices);
          const filteredDevices = devices.filter(device => device.kind === 'audiooutput');
          return Promise.resolve(filteredDevices);
        } catch (error) {
          return Promise.reject(error);
        }
      }

      async function getVideoInput(index) {
        try {
          const devices = await listVideoInputs();
          if (devices.length > index) {
            return Promise.resolve(devices[index]);
          }
          
          return Promise.resolve(null);
        } catch (error) {
          return Promise.reject(error);
        }
      }

      async function getAudioInput(index) {
        try {
          const devices = await listAudioInputs();
          if (devices.length > index) {
            return Promise.resolve(devices[index]);
          }
          
          return Promise.resolve(null);
        } catch (error) {
          return Promise.reject(error);
        }
      }

      async function getNextVideoInputindex() {
        try {
          const devices = await listVideoInputs();
          const newIndex = (videoDeviceIndex + 1) % devices.length;
          return Promise.resolve(newIndex);
        } catch (error) {
          return Promise.reject(error);
        }
      }

      async function getNextAudioInputIndex() {
        try {
          const devices = await listAudioInputs();
          const newIndex = (audioDeviceIndex + 1) % devices.length;
          return Promise.resolve(newIndex);
        } catch (error) {
          return Promise.reject(error);
        }
      }

      async function cycleCameraManual() {
        if (cameraPublisher == null) {
          return;
        }

        const nextIndex = await getNextVideoInputindex();
        if (nextIndex === videoDeviceIndex) {
          // Not changed
          return;
        }

        // Unpublish and Republish
        startCamera();
      }

      async function cycleCameraAuto() {
        if (cameraPublisher != null) {
          cameraPublisher.cycleVideo();
        }
      }

      async function cycleCamera() {
        if (videoCycleMode === 'auto') {
          return cycleCameraAuto();
        } else {
          return cycleCameraManual();
        }
      }
    
      async function showContentHintDialog(){
          document.getElementById("contenthint-control").style.visibility = "visible";
           document.getElementById("contenthint-control").style.display = "block";
      }
      async function onContentHintChanged(){
          contentHintType = document.getElementById("content-hint-select").value;
          document.getElementById("contenthint-control").style.visibility = "hidden";
          startScreen();
      }
      
      async function onContentHintCancelled(){
          document.getElementById("contenthint-control").style.visibility = "hidden";
      }

      async function startScreen() {
        stopScreen();
        try {
          const name = document.getElementById('name').value;
          if (name == null || name === '') {
            alert('Please provide a name');
            return;
          }

          screenPublisher = OT.initPublisher('screenContainer', {
            videoSource: 'screen',
            fitMode: 'contain',
            insertMode: 'append',
            name: `${name}-screen`,
            resolution: '1280x720',
            showControls: false,
            width: '100%',
            height: '100%',
            videoContentHint: contentHintType,
            style: { nameDisplayMode: "off" }
          }, (error) => {
            if (error) {
              console.log('Screen: error when init');
              handleError(error);
              stopScreen();
              return;
            }
            
            // Publish to Session
            OTSession.publish(screenPublisher, (err) => {
              if (err) {
                console.log('Screen: error when publishing');
                handleError(error);
                return;
              }
                
              var label = document.createElement("label");
              label.id = screenPublisher.id+"lbl";
              label.classList.add("statslabel");
              document.getElementById(screenPublisher.id).appendChild(label);
              otStats.addPublisher(screenPublisher);
              document.getElementById('button-screen-share').classList.remove('Vlt-btn--tertiary');
              document.getElementById('button-screen-share').classList.add('Vlt-btn--primary');
              
              otSpeech.notifySpeakerChange();
            })
          });

          screenPublisher.on('streamCreated', (event) => {
            console.log('Screen Publisher streamCreated');
            otSpeech.notifySpeakerChange();

            // Add Publisher Annotation (screen only)
            otAnnotation.startPublisher(screenPublisher);
          });

          screenPublisher.on('streamDestroyed', (event) => {
            console.log('Screen Publisher streamDestroyed');
            otStats.removePublisher(screenPublisher.id);
            // Remove Publisher Annotation (screen only)
            otAnnotation.endPublisher(screenPublisher)

            stopScreen();
          });
        } catch (error) {
          handleError(error);
          console.log('Screen: error when starting screen');
        }
      }
      
      function stopScreen() {
        if (screenPublisher != null) {
          OTSession.unpublish(screenPublisher);
          screenPublisher = null;
        }

        document.getElementById('button-screen-share').classList.remove('Vlt-btn--primary');
        document.getElementById('button-screen-share').classList.add('Vlt-btn--tertiary');

        otSpeech.notifySpeakerChange();
      }

      async function startVideoPlayer(file) {
        stopVideoPlayer();
        try {
          const name = document.getElementById('name').value;
          if (name == null || name === '') {
            alert('Please provide a name');
            return;
          }

          videoPlayerElement = document.createElement('video');
          videoPlayerElement.classList.add('OT_video-element');
          videoPlayerElement.style.minWidth = "100%";
          videoPlayerElement.style.minHeight = "100%";
          videoPlayerElement.style.width = "160";
          videoPlayerElement.style.height = "90";

          videoPlayerContainer = document.createElement('div');
          videoPlayerContainer.style.display = 'flex';
          videoPlayerContainer.style.overflow = 'hidden';

          videoPlayerContainer.appendChild(videoPlayerElement);
          document.getElementById('screenContainer').appendChild(videoPlayerContainer);
          otSpeech.notifySpeakerChange();

          const objectUrl = URL.createObjectURL(file);
          videoPlayerElement.src = objectUrl;
          videoPlayerElement.controls = true;
          videoPlayerElement.onloadeddata = () => {
            const mediaStream = videoPlayerElement.captureStream != null
              ? videoPlayerElement.captureStream() // Newer Browsers
              : videoPlayerElement.mozCaptureStream(); // Older Firefox

            const videoTracks = mediaStream.getVideoTracks();
            const audioTracks = mediaStream.getAudioTracks();

            const hasVideo = videoTracks && videoTracks.length > 0;
            const hasAudio = audioTracks && audioTracks.length > 0;

            const videoSource = hasVideo ? videoTracks[0] : null;
            const audioSource = hasAudio ? audioTracks[0] : null;

            videoPublisher = OT.initPublisher(null, {
              audioSource: audioSource,
              videoSource: videoSource,
              publishVideo: hasVideo,
              publishAudio: hasAudio,
              insertDefaultUI: false,
              name: `${name}-video`,
              showControls: false,
              resolution: '1280x720',
              style: { nameDisplayMode: "off" }
            }, (error) => {
              if (error) {
                handleError(error);
                stopVideoPlayer();
                return;
              }
              
              // Publish to Session
              OTSession.publish(videoPublisher, (err) => {
                if (err) {
                  handleError(error);
                  return;
                }

                document.getElementById('button-video-player').classList.remove('Vlt-btn--tertiary');
                document.getElementById('button-video-player').classList.add('Vlt-btn--primary');
                
                otSpeech.notifySpeakerChange();
              })
            });

            videoPublisher.on('streamCreated', (event) => {
            console.log('Video Publisher streamCreated');
              otSpeech.notifySpeakerChange();
            });

            videoPublisher.on('streamDestroyed', (event) => {
            console.log('Video Publisher streamDestroyed');
              stopVideoPlayer();
            });
          };
          videoPlayerElement.play();
        } catch (error) {
          handleError(error);
        }
      }
      
      function stopVideoPlayer() {
        if (videoPublisher != null) {
          OTSession.unpublish(videoPublisher);
          videoPublisher = null;
        }

        // Delete Old Video if available
        if (videoPlayerElement != null) {
          videoPlayerContainer.removeChild(videoPlayerElement);
          document.getElementById('screenContainer').removeChild(videoPlayerContainer);

          videoPlayerElement.pause();
          videoPlayerElement.removeAttribute('src');
          videoPlayerElement.load();
          videoPlayerElement = null;
        }

        document.getElementById('button-video-player').classList.remove('Vlt-btn--primary');
        document.getElementById('button-video-player').classList.add('Vlt-btn--tertiary');

        otSpeech.notifySpeakerChange();
      }

      function endCall() {
        window.location.href = "/thankyou.html";
      }

      function updateConnectionCount() {
        console.log(`Connection Count: ${connectionCount}`);
        document.getElementById('participant-count').innerText = `Number of Participants: ${connectionCount}`;
      }

      function updateSpeakerPins() {
        // Fill Available Speaker List
        const speakerElements = otSpeech.getOrderedChannels()
          .sort((a, b) => {
            // Pinned on top
            if (a.pinned && !b.pinned) {
              return -1;
            } else if (b.pinned && !a.pinned) {
              return 1;
            }

            return (a.subscriber.stream || {}).name.toLowerCase() < (b.subscriber.stream || {}).name.toLowerCase() ? -1 : 1; // sort by speaker name (case-insensitive)
          })
          .map((speaker) => {
            // Speaker Div
            const speakerElement = document.createElement('div');
            speakerElement.style.width = '100%';
            speakerElement.style.display = 'flex';
            speakerElement.style.flexDirection = 'row';
            speakerElement.style.alignItems = 'center';

            // Icon Button
            const iconButton = document.createElement('button');
            iconButton.classList.add('Vlt-btn');
            iconButton.classList.add('Vlt-btn--app');
            iconButton.classList.add('Vlt-btn--icon');
            iconButton.classList.add(speaker.pinned ? 'Vlt-btn--primary' : 'Vlt-btn--tertiary');
            iconButton.style.marginRight = '16px';
            iconButton.style.width = '24px';
            iconButton.style.height = '24px';
            iconButton.style.minWidth = '24px';
            iconButton.style.minHeight = '24px';
            iconButton.style.padding = '2px';
            iconButton.onclick = () => otSpeech.setSpeakerPin(speaker.id, !speaker.pinned);

            // Icon SVG
            const iconElement = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            iconElement.style.color = '#ff0000';
            iconElement.innerHTML = '<use xlink:href="volta-icons.svg#Vlt-icon-pin-2" />';
            iconElement.style.width = '12px';
            iconElement.style.height = '12px';
            iconButton.appendChild(iconElement);

            // Speaker Name
            const nameElement = document.createElement('label');
            nameElement.innerText = ((speaker.subscriber.stream) || {}).name || speaker.id;

            speakerElement.appendChild(iconButton);
            speakerElement.appendChild(nameElement);
            return speakerElement;
          });

        const speakerListElement = document.getElementById('speaker-list');
        speakerListElement.innerHTML = '';
        for (let i = 0; i < speakerElements.length; i += 1) {
          const speakerElement = speakerElements[i];
          speakerListElement.appendChild(speakerElement);
        }
      }

      async function refreshRecording(archives) {
        try {
          let isRecording = false;
          if (archives.length > 0) {
            const archive = archives[0];
            const { status } = archive;
            isRecording = status === 'started' || status === 'paused';
          }

          recording = isRecording;
          if (recording) {
            document.getElementById('button-record').onclick = toggleRecord;
            document.getElementById('button-record').classList.remove('Vlt-btn--tertiary');
            document.getElementById('button-record').classList.add('Vlt-btn--destructive');
          } else {
            document.getElementById('button-record').onclick = toggleRecord;
            document.getElementById('button-record').classList.remove('Vlt-btn--destructive');
            document.getElementById('button-record').classList.add('Vlt-btn--tertiary');
          }
        } catch (error) {
          console.error(error);
        }
      }

      async function toggleRecord() {
        try {
          const url = `/archives`;
          const action = recording ? 'stop' : 'start';
          const body = {
            sessionId: roomSessionId,
            action,
          };
          const config = {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(body),
          };
          if (accessToken != null && accessToken !== '') {
            config.headers['Authorization'] = `Bearer ${accessToken}`;
          }

          // Disable Action
          document.getElementById('button-record').onclick = null;

          const response = await fetch(url, config);

          await refreshArchives();
        } catch (error) {
          console.error(error);
        }
      }

      function toggleAudioEnable() {
        enableAudio = !enableAudio;
        cameraPublisher.publishAudio(enableAudio);
        
        if (enableAudio) {
          document.getElementById('button-audio-enable').classList.remove('Vlt-btn--tertiary');
          document.getElementById('button-audio-enable').classList.add('Vlt-btn--primary');
          document.getElementById('button-audio-enable').innerHTML = `<svg><use xlink:href="volta-icons.svg#Vlt-icon-microphone-full" /></svg>`;
        } else {
          document.getElementById('button-audio-enable').classList.remove('Vlt-btn--primary');
          document.getElementById('button-audio-enable').classList.add('Vlt-btn--tertiary');
          document.getElementById('button-audio-enable').innerHTML = `<svg><use xlink:href="volta-icons.svg#Vlt-icon-microphone-mute-full" /></svg>`;
        }
      }

      function toggleVideoEnable() {
        enableVideo = !enableVideo;
        cameraPublisher.publishVideo(enableVideo);
        
        if (enableVideo) {
          document.getElementById('button-video-enable').classList.remove('Vlt-btn--tertiary');
          document.getElementById('button-video-enable').classList.add('Vlt-btn--primary');
          document.getElementById('button-video-enable').innerHTML = `<svg><use xlink:href="volta-icons.svg#Vlt-icon-video-negative" /></svg>`;
        } else {
          document.getElementById('button-video-enable').classList.remove('Vlt-btn--primary');
          document.getElementById('button-video-enable').classList.add('Vlt-btn--tertiary');
          document.getElementById('button-video-enable').innerHTML = `<svg><use xlink:href="volta-icons.svg#Vlt-icon-video-off-full" /></svg>`;
        }
      }

      function toggleSidebar() {
        const sidebarElement = document.getElementById('sidebar');
        sidebarElement.hidden = !sidebarElement.hidden;
        const isHidden = sidebarElement.style.display === 'none';
        if (isHidden) {
          // Unhide
          sidebarElement.style.display = 'flex';
          document.getElementById('button-collapse-sidebar').style.display = 'block';
          document.getElementById('button-expand-sidebar').style.display = 'none';
          
          document.getElementById('sidebar-control').style.display = 'none';
        } else {
          // Hide
          sidebarElement.style.display = 'none';
          document.getElementById('button-collapse-sidebar').style.display = 'none';
          document.getElementById('button-expand-sidebar').style.display = 'block';

          document.getElementById('sidebar-control').style.display = 'block';
        }

        otSpeech.notifySpeakerChange();
      }

      function onChatEnter(event) {
        if (event.key === 'Enter') {
          if (!event.shiftKey) {
            sendChat();
          }
        }
      }

      function onActiveSpeakerSettingChanged(event) {
        otSpeech.setNumberOfActiveSpeakers(event.target.value);
      }

      async function onVideoSourceChanged(event) {
        const value = event.target.value.replace('video-source-', '');
        if (value === 'vg-default') {
          return;
        }

        const index = parseInt(value, 10);
        videoDeviceIndex = index;

        if (videoCycleMode === 'auto' && videoDeviceIndex > -1) {
          const videoDevice = await getVideoInput(videoDeviceIndex);
          if (videoDevice != null) {
            setVideoSource(videoDevice.deviceId);
          }
        } else {
          startCamera();
        }
      }

      async function onAudioSourceChanged(event) {
        const value = event.target.value.replace('audio-source-', '');
        if (value === 'vg-default') {
          return;
        }

        const index = parseInt(value, 10);
        audioDeviceIndex = index;

        if (videoCycleMode === 'auto' && audioDeviceIndex > -1) {
          const audioDevice = await getAudioInput(audioDeviceIndex);
          if (audioDevice != null) {
            setAudioSource(audioDevice.deviceId);
          }
        } else {
          startCamera();
        }
      }

      function onAudioSinkChanged(event) {
        const value = event.target.value.replace('audio-sink-', '');
        if (value === 'vg-default') {
          return;
        }

        console.log(`Change Audio Sink to ${value}`);
        const elements = document.getElementsByTagName('video');
        for (let i = 0; i < elements.length; i += 1) {
          const element = elements[i];
          element.setSinkId(value);
        }

        audioSinkId = value;
      }

      async function muteAll() {
        const muteCheckbox = document.getElementById('mute-all-checkbox');
        muteCheckbox.disabled = true;
        try {
          const mute = muteCheckbox.checked;
          const url = `/muteAll?room=${roomName}&mute=${mute}`;
          const config = {};
          if (accessToken != null && accessToken !== '') {
            config.headers = {
              Authorization: `Bearer ${accessToken}`,
            };
          }
          await fetch(url, config);
        } catch (error) {
          console.error(error);
        } finally {
          muteCheckbox.disabled = false;
        }
      }

      function enableSound() {
        const enableSoundCheckbox = document.getElementById('enable-sound-checkbox');
        enableSoundCheckbox.disabled = true;
        enableSoundEffect = enableSoundCheckbox.checked;
        enableSoundCheckbox.disabled = false;
      }

      /*function enableSpatialAudio(){
          if(otSpacialAudio.getAudioMode() == otSpacialAudio.MODE_NONE)
            otSpacialAudio.setAudioMode(otSpacialAudio.MODE_SPATIAL);
          else
            otSpacialAudio.setAudioMode(otSpacialAudio.MODE_NONE);
      }*/
        
      function enableStats(){
          if(enableStatsFlag === true){
              enableStatsFlag = false;
              otStats.stop();
              console.log("stopped stats");
               var labels = document.getElementsByClassName("statslabel");
               for(i=0; i<labels.length; i++) {
                  labels[i].style.visibility = "hidden";
               }
               document.getElementById("combinedstats").style.visibility="hidden";
          }
          else{
              enableStatsFlag = true;
              otStats.start();
              console.log("starting stats");
              var labels = document.getElementsByClassName("statslabel");
               for(i=0; i<labels.length; i++) {
                  labels[i].style.visibility = "visible";
               }
              document.getElementById("combinedstats").style.visibility="visible";
          }
      }
      function sendChat() {
        const text = document.getElementById('chat-text').value;
        const name = document.getElementById('name').value;

        if (text == null || text === '') {
          return;
        }

        OTSession.signal({
          type: 'chat',
          data: JSON.stringify({
            name,
            text,
          }),
        }, (error) => {
          if (error) {
            console.error(error);
            return;
          }

          // Clear textbox
          document.getElementById('chat-text').value = '';
          console.log('Chat sent');
        });
      }

      function setStreamControlHoverListener() {
        const videoContainer = document.getElementById('videoContainer');
        const streamControlContainer = document.getElementById('stream-control');
        const sidebarControlContainer = document.getElementById('sidebar-control');

        const handleMouseEnter = (e) => {
          if (streamControlHideTimeout != null) {
            clearTimeout(streamControlHideTimeout);
          }

          streamControlContainer.hidden = false;
          
          // Show Sidebar Control
          sidebarControlContainer.hidden = false;
        };

        const handleMouseLeave = (e) => {
          console.log('mouse leave');
          if (streamControlHideTimeout != null) {
            clearTimeout(streamControlHideTimeout);
          }

          streamControlHideTimeout = setTimeout(() => {
            streamControlContainer.hidden = true;

            // Hide Sidebar Control
            sidebarControlContainer.hidden = true;
          }, hideControlDelay)
        };

        videoContainer.ontouchstart = handleMouseEnter;
        videoContainer.onmouseenter = handleMouseEnter;
        videoContainer.ontouchend = handleMouseLeave;
        videoContainer.onmouseleave = handleMouseLeave;
      }

      function onSignIn(googleUser) {
        const profile = googleUser.getBasicProfile();
        document.getElementById('name').value = profile.getName();

        const idToken = googleUser.getAuthResponse().id_token;
        accessToken = idToken;
        googleUser.disconnect();

        initializeSession();
      }

      async function toggleWhiteboard() {
        document.getElementById('button-whiteboard-enable').onclick = null;

        if (!whiteboardStarted) {
          startWhiteboard(true);
          const url = `/invision/start`;
          const body = { sessionId: roomSessionId };
          const config = {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(body),
          };
          if (accessToken != null && accessToken !== '') {
            config.headers['Authorization'] = `Bearer ${accessToken}`;
          }

          await fetch(url, config);
        } else {
          stopWhiteboard(true);
          const url = `/invision/stop`;
          const body = { sessionId: roomSessionId };
          const config = {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(body),
          };
          if (accessToken != null && accessToken !== '') {
            config.headers['Authorization'] = `Bearer ${accessToken}`;
          }

          await fetch(url, config);
        }

        document.getElementById('button-whiteboard-enable').onclick = toggleWhiteboard;
      }

      function startWhiteboard(notifyEveryone = false) {
        if (whiteboardStarted) {
          console.log('Whiteboard has already started');
          return;
        }

        // Add iFrame
        whiteboardIFrame = document.createElement('iframe');
        whiteboardIFrame.title = 'Whiteboard';
        whiteboardIFrame.src = `/invision?room=${roomName}`;
        screenContainer.appendChild(whiteboardIFrame);

        document.getElementById('button-whiteboard-enable').classList.remove('Vlt-btn--tertiary');
        document.getElementById('button-whiteboard-enable').classList.add('Vlt-btn--primary');

        whiteboardStarted = true;
        otSpeech.notifySpeakerChange();

        if (notifyEveryone) {
          sendWhiteboardSignal(true);
        }
      }

      function stopWhiteboard(notifyEveryone = false) {
        if (!whiteboardStarted) {
          console.log('Whiteboard is not started');
          return;
        }

        // Remove iFrame
        screenContainer.removeChild(whiteboardIFrame);
        whiteboardIFrame = null;

        document.getElementById('button-whiteboard-enable').classList.add('Vlt-btn--tertiary');
        document.getElementById('button-whiteboard-enable').classList.remove('Vlt-btn--primary');
        
        whiteboardStarted = false;
        otSpeech.notifySpeakerChange();

        if (notifyEveryone) {
          sendWhiteboardSignal(false);
        }
      }

      function sendWhiteboardSignal(enabled) {
        OTSession.signal({
          type: 'whiteboard',
          data: JSON.stringify({ enabled }),
        }, (error) => {
          if (error) {
            console.error(error);
            return;
          }
        });
      }

      async function toggleTranscription() {
        document.getElementById('button-record').onclick = null;

        transcriptionStarted = !transcriptionStarted;
        if (transcriptionStarted) {
          // Start Transcription
          await startTranscription();

        } else {
          // Stop Transcription
          await stopTranscription();

        }

        if (transcriptionStarted) {
          document.getElementById('button-transcription-enable').classList.remove('Vlt-btn--tertiary');
          document.getElementById('button-transcription-enable').classList.add('Vlt-btn--primary');
        } else {
          document.getElementById('button-transcription-enable').classList.add('Vlt-btn--tertiary');
          document.getElementById('button-transcription-enable').classList.remove('Vlt-btn--primary');
        }

        document.getElementById('button-record').onclick = toggleTranscription;
      }

      async function startTranscription() {
        if (roomSessionId == null || roomSessionId === '') {
          alert('No Session Detected');
          return;
        }

        try {
          const transcribeHost = await getTranscriptionHost();
          const credentials = await getCredentials();

          
          const url = `${transcribeHost}/transcribe`;
          const body = {
            ...credentials,
            filterEnabled: true, // Enable Profanity Filter
          };
          const config = {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(body),
          };

          const response = await fetch(url, config);

          // Signal Everyone
          OTSession.signal({
            type: 'transcriptionStatus',
            data: 'started',
          }, (error) => {
            if (error) {
              console.error(error);
            }
          });
        } catch (error) {
          console.error(error);
        }
      }

      async function stopTranscription() {
        if (roomSessionId == null || roomSessionId === '') {
          alert('No Session Detected');
          return;
        }

        try {
          const transcribeHost = await getTranscriptionHost();
          const credentials = await getCredentials();

          
          const url = `${transcribeHost}/transcribe/${roomSessionId}`;
          const body = credentials;
          const config = {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(body),
          };

          const response = await fetch(url, config);

          // Signal Everyone
          OTSession.signal({
            type: 'transcriptionStatus',
            data: 'stopped',
          }, (error) => {
            if (error) {
              console.error(error);
            }
          });

        } catch (error) {
          console.error(error);
        }
      }

      async function getTranscriptionHost() {
        try {
          const url = '/transcribeHost';
          const config = {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
          };

          const response = await fetch(url, config);
          const data = await response.json();
          const { host: transcribeHost } = data;
          return Promise.resolve(transcribeHost);
        } catch (error) {
          console.error(error);
          return Promise.reject(error);
        }
      }

      async function isTranscriptionRunning() {
        try {
          if (roomSessionId == null || roomSessionId === '') {
            alert('No Session Detected');
            return Promise.resolve(false);
          }

          const transcribeHost = await getTranscriptionHost();
          const url = `${transcribeHost}/transcribe/${roomSessionId}`;
          const config = {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
            },
          };

          const response = await fetch(url, config);
          const data = await response.json();
          return Promise.resolve(data.exist);
        } catch (error) {
          return Promise.reject(error);
        }
      }

      async function joinTranscriptionRoom() {
        try {
          const transcribeHost = await getTranscriptionHost();
          if (transcribeHost == null) {
            return Promise.resolve(false);
          }

          // Join Socket IO
          transcriptionSocket = io(transcribeHost);
          transcriptionSocket.on('connect', () => {
            console.log('Connected to Socket IO');

            // Join Room
            transcriptionSocket.emit('join', { room: roomSessionId });
          });

          transcriptionSocket.on('disconnect', () => {
            console.log('Disconnected from Socket IO');
          });

          transcriptionSocket.on('transcription', text => setTranscriptionText(text));
        } catch (error) {
          return Promise.reject(error);
        }
      }

      function refreshDeviceList() {
        listVideoInputs()
          .then(devices => {
            const videoSelect = document.getElementById('video-source-select');
            videoSelect.innerHTML = '';

            // Select Input
            const disabledOption = document.createElement('option');
            disabledOption.disabled = true;
            disabledOption.innerText = "Select Input";
            disabledOption.value = "select";
            disabledOption.selected = true;
            videoSelect.appendChild(disabledOption);

            for (let i = 0; i < devices.length; i += 1) {
              const device = devices[i];
              const deviceOption = document.createElement('option');
              deviceOption.innerText = device.label || `Video Input ${i+1}`;
              deviceOption.value = `video-source-${i}`;

              videoSelect.appendChild(deviceOption);
            }

            if (devices.length === 0) {
              const deviceOption = document.createElement('option');
              deviceOption.innerText = 'Default Video Input';
              deviceOption.value = `video-source-vg-default`;

              videoSelect.appendChild(deviceOption);
            }
          });

        listAudioInputs()
          .then(devices => {
            const audioSelect = document.getElementById('audio-source-select');
            audioSelect.innerHTML = '';

            // Select Input
            const disabledOption = document.createElement('option');
            disabledOption.disabled = true;
            disabledOption.innerText = "Select Input";
            disabledOption.value = "select";
            disabledOption.selected = true;
            audioSelect.appendChild(disabledOption);

            for (let i = 0; i < devices.length; i += 1) {
              const device = devices[i];
              const deviceOption = document.createElement('option');
              deviceOption.innerText = device.label || `Audio Input ${i+1}`;
              deviceOption.value = `audio-source-${i}`;

              audioSelect.appendChild(deviceOption);
            }

            if (devices.length === 0) {
              const deviceOption = document.createElement('option');
              deviceOption.innerText = 'Default Audio Input';
              deviceOption.value = `audio-source-vg-default`;

              audioSelect.appendChild(deviceOption);
            }
          });

        listAudioOutputs()
          .then(devices => {
            const audioSelect = document.getElementById('audio-sink-select');
            audioSelect.innerHTML = '';

            // Select Output
            const disabledOption = document.createElement('option');
            disabledOption.disabled = true;
            disabledOption.innerText = "Select Output";
            disabledOption.value = "select";
            disabledOption.selected = true;
            audioSelect.appendChild(disabledOption);

            for (let i = 0; i < devices.length; i += 1) {
              const device = devices[i];
              const deviceOption = document.createElement('option');
              deviceOption.innerText = device.label || `Audio Output ${i+1}`;
              deviceOption.value = `audio-sink-${device.deviceId}`;

              audioSelect.appendChild(deviceOption);
            }

            if (devices.length === 0) {
              const deviceOption = document.createElement('option');
              deviceOption.innerText = 'Default Audio Output';
              deviceOption.value = `audio-sink-vg-default`;

              audioSelect.appendChild(deviceOption);
            }
          });
      }

      if (window.location.href.toString().indexOf('http://') === 0 && window.location.href.toString().indexOf('http://localhost') !== 0) {
        window.location.href = window.location.href.toString().replace("http://", "https://");
      }

      waitForReady(() => {
        Volta.init(['tab', 'tooltip', 'modal']);

        const params = getParams();
        let {
          name, token, highlight,
          room,
          max, ratio, 
          unpublish_delay, retry_limit,
          hide_control_delay,
          role = 'user',
          sound,
          cycleMode = 'auto',
          sub,
          whiteboard = 'false',
          hide_sidebar = 'false',
          disable_sidebar = 'false',
        } = params;

        const numberOfActiveSpeakers = parseInt((max || '4'), 10);
        const aspectRatio = ratio === '16_9' ? 16 / 9 : 4 / 3;
        highlight = (highlight || 'true').toLowerCase() === 'true';
        tokenParam = token;
        unpublishDelay = parseInt((unpublish_delay || '30'), 10);
        retryLimit = parseInt((retry_limit || '0'), 10);
        retryCount = retryLimit;
        hideControlDelay = parseInt((hide_control_delay || '1000'), 10);
        roomName = room;
        userRole = role;
        enableSoundEffect = (sound || 'true') === 'true';
        enableTranscription = (sub || 'false') === 'true';
        enableWhiteboard = (whiteboard || 'false') === 'true';
        videoCycleMode = cycleMode;
        
        const shouldHideSideBar = (hide_sidebar || 'false') === 'true';
        const shouldDisableSideBar = (disable_sidebar || 'false') === 'true';

        ({ adjustLayout, updateHighlight, addSelfSpeakerId, removeSelfSpeakerId } = OTLayout(layoutContainer, screenContainer, { aspectRatio, highlight }));
        otSpeech = OTSpeech({ numberOfActiveSpeakers });
        otSpeech.setOnActiveSpeakerChangeListener(onSpeakerOrderChanged);
        otSpeech.setOnMostActiveSpeakerChangeListener(onMostActiveSpeakerChanged);

        

        if (room != null && room.charAt(0) === '_') {
          document.getElementById('room').value = room || '';
          document.getElementById('name').disabled = true;
          document.getElementById('connect').disabled = true;
          document.getElementById('session-control').hidden = true;
          document.getElementById('name-control').hidden = true;
        } else {
          document.getElementById('room').value = room || '';
          document.getElementById('room-control').hidden = false;
        }

	if (name != null && name != '') {
          document.getElementById('name').value = name;
          document.getElementById('session-control').hidden = true;
          document.getElementById('name-control').hidden = true;
          initializeSession();
        } else {
          document.getElementById('session-control').hidden = false;
          document.getElementById('name-control').hidden = false;
        }
	      
        if (userRole === 'admin') {
          document.getElementById('recording').style.display = 'flex';
          document.getElementById('recording').hidden = false;
          document.getElementById('mute-all').style.display = 'flex';
          document.getElementById('mute-all').hidden = false;
          document.getElementById('button-record').style.display = null;
        } else {
          document.getElementById('button-record').style.display = 'none';
        }

        if (enableTranscription && userRole === 'admin') {
          document.getElementById('button-transcription-enable').style.display = null;
        } else {
          document.getElementById('button-transcription-enable').style.display = 'none';
        }

        if (enableWhiteboard) {
          document.getElementById('button-whiteboard-enable').style.display = null;
        } else {
          document.getElementById('button-whiteboard-enable').style.display = 'none';
        }

        if (shouldDisableSideBar) {
          document.getElementById('sidebar-control').style.display = 'none';
          toggleSidebar();
        } else if (shouldHideSideBar) {
          toggleSidebar();
        }
        
        /*if(isSafari()){
            document.getElementById("enhance-audio").style.display="none";
            spacialAudioSupported = false;
        }
        else{
            otSpacialAudio.initResonanceAudio();      
        }*/
        document.getElementById('enable-sound-checkbox').checked = enableSoundEffect;

        document.title = roomName || 'Vonage Roundtable'
        document.getElementById('number-of-active-speakers-select').value = numberOfActiveSpeakers;

        // document.addEventListener('touchstart', e => e.preventDefault());
        // document.addEventListener('touchmove', e => e.preventDefault());

        refreshDeviceList();
        navigator.mediaDevices.ondevicechange = () => {
          console.log('Media Devices change detected, refreshing list');
          refreshDeviceList();
        }
      });
      function isSafari(){
          return !!navigator.userAgent.match(/Version\/[\d\.]+.*Safari/);
      }
    </script>
    
    <script src="volta.min.js"></script>
    <script src="popper.min.js"></script>
    <script src="tooltip.min.js"></script>
  </body>
</html>
